### 框架的好与坏
关于多线程的游戏服务器架构，不同公司，不同项目的设计很可能都是不一样的，这很正常。
每个人的技术栈可能不一样，编程思想也有很大差别，游戏需求也不一样，
此外多线程的设计往往涉及很多取舍，每个人都有自己的取舍，因此诞生出各种各样的框架。   

一个框架的好坏不能只看某个方面，没有完美的框架，一个框架最重要的是适合自己。
虽然存在众多框架，但不一定能找到一个适合自己的框架，甚至找到具有参考价值的都不容易。  
举个栗子：PHP是世界上最好的语言！

我可能会表露我不喜欢什么样的设计，这不代表我的设计就一定比它好！  
记住：**取舍**！

### 我的坚持--编程模型的简单性
我不会追求极致的性能，我会尽量保持编程模型的简单性，同时尽量地拓展性能。  

#### 为什么？
编程模型如果不够简单，对于有经验的开发人员来说,容易陷入考虑各种各样的复杂情况中，花在这上面的时间很可能超过他们做真正有意义的开发的时间，开发效率太低；  
而对于普通程序员，甚至可能不知道存在的问题！总的来说：编程模型复杂，导致编程效率较低，以及正确性很难保证！  

举个栗子：  
纯异步编程模型，当方法调用链过长的时候是个灾难，当提供回调机制的时候，更加恐怖，它可能产生内存泄漏，可见性问题，以及其它逻辑错误。  
建议：使用回调机制时，不要乱传递数据（不要乱捕获数据）。  

总的来说：  
    复杂的编程模型对团队的成员提出了更高的要求，只有团队成员都足够优秀的时候，才能保证正确性和开发效率，它可能是为了极致的性能，也可能是为了其它。  
而我往往对团队的成员并不充满信心，一个团队良莠不齐很正常，优秀的人少，多数人是hold不住的。
因此我选择舍弃一部分性能，换得更简单的编程模型，以保证开发效率和正确性。

### 哪些模块适合多线程化
游戏架构的各个模块其实都可以多线程化，但是最重要的是Scene服多线程化，因为scene更容易遇见性能瓶颈。
至于其它模块，如果没有太大压力，单线程就足够了。

### 如何将Scene服多线程化？
对于这个问题，其实有好几种方式，如：
1. 按业务逻辑划分线程：AOI管理，AI管理，战斗，其它玩法。 
    1. 逻辑拆分的太细，涉及大量的共享数据，编程复杂度极高。很难保证安全性。
    2. 我觉得这样设计的人对多线程技术怕是有误解。线程的任务之间有过多的依赖和数据交互，是不适合多线程化的。
    3. 极其不推荐，极其不推荐，极其不推荐！！！

2. 按场景划分线程：对MMO游戏来说，一个场景内的所有逻辑在一个线程内。对于开房间类型的游戏，按房间划分线程。
    1. 这样的划分方式还是很合理的，个人认为一个场景应该作为最小单元。
    2. 这种方式，只有当玩家在同一个场景下时，数据才是直接可用的。
    3. 拿交易系统举例，只有玩家面对面在一个场景下时，这个操作才是允许的。
    4. 它对程序的性能是最友好的，但是对玩家体验是最不好的。

3. 按区域划分线程：对MMO游戏来说，将一个进程要负责的地图划分为多个区域，一个区域的逻辑在一个线程。区域的划分方式不要拘泥于游戏地图，可以有多种划分方式：
    1. 按照游戏地图划分，比如 1-30级的地图在一个线程；31-50级的地图在一个线程... 玩家只有在同一个区域时，数据才是可直接使用的。
    2. 主城在一个线程；有数据依赖的地图在一个线程；各种玩法地图（eg：副本）可以在任意线程。 -- 这种划分适合玩家的交互基本都在主城，且可以跨主城直接交互时。
    3. 拿交易系统举例，只有玩家进入同一个区域下时（或都在主城时），这个操作才是允许的。
    4. 当想降低一部分性能提高体验，或想降低一部分体验提高性能时，可以采用这种方式。

4. 一个进程内的线程是等价的，每个线程都拥有完整的游戏逻辑。（可以看做分线） ---> 它对玩家的操作支持是最好的。
    1. 这样的划分方式也有它的好处，每一个线程是独立且同构的；
    2. 这样的划分方式，存在性能浪费。但是对玩家操作支持范围是最大的。
    3. 拿交易系统举例，只有玩家进入同一个分线时，这个操作才是允许的。
    4. 它对玩家的体验是最好的，对程序的性能是最不好的。（如果游戏分频道或分线，我其实建议使用这种）

**注意**:
1. 划分线程并不一定是为模块新建线程，而是说这部分模块绑定在一个线程上，一个线程上可能有多个模块；
类似Netty中 Channel与EventLoop之间的关系。
2. 划分的太细(小)时：当游戏逻辑较复杂时，各个小的模块之间涉及大量的数据共享。
要解决这种问题，要么加锁处理竞争，要么使用消息进行通信（异步化），无论哪一种都会大大加重开发人员的负担。
这也是我极不推荐第一种划分方式的原因。
3. 划分的太粗糙时：每个线程可能存在不必要的任务，造成性能浪费。性能无法最大化。
我的建议是，可以适当的粗糙一点，而不要追求尽量的小。
4. 选择必须符合游戏需求，不能强制让游戏按照架构设计！需求决定架构，而不是架构决定需求。
5. 我不推荐纯异步的编程模型(使用消息交互)，推荐在确定边界内使用同步编程。

### 多线程化需要注意的一些问题
1. 缓存。在多线程下慎用全局缓存（静态变量），如果要使用缓存，建议优先考虑ThreadLocal。
2. 为了减少开发人员的错误，建议单个线程下只能获取到自己能用的数据。这要求数据存储的位置要精心设计。
3. 想到再说...