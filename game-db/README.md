### fastjgame项目 数据库组件

#### 为什么始终没开始写？
主要考虑两个方面：  
+ ODM 对象文档映射(类似SQL的ORM)。
>1. ODM并不是个必要组件，因为ODM会大大限制你使用数据的方式，对于复杂的数据很不友好，而游戏需求复杂多变，如果数据扩展或数据结构变更困难的话，是很致命的问题；
>2. 采用反射的方式，是最容易实现，也较容易扩展的。但是性能较差，可能差到可能无法接受(玩家数据较大，且构成复杂)。
>3. 也有开源的ODM实现，但是也存在对复杂数据结构不友好和性能问题。  
>4. 鉴于上面几点，应该是不会实现ODM了，也不会采用ODM。自己写入库代码虽然有一些重复工作，但负担其实不大，而且在面对数据结构变更时更容易处理。

+ 异步实时入库。
> 这个是个真正的问题，也是真正阻碍我进行下一步的问题。还没有想好对应的架构。


#### 分布式架构下玩家数据库如何更新？
我知道的有两种：
1. 场景服务器直接操作数据库。
2. 场景服不直接操作数据库，而是将数据同步给另一个服务器(DB服务器/中心服务器)，由DB服务器完成入库。  
不论哪一种，都可能产生时序问题。原因:如果玩家在切换场景之后，改变了线程，且上一个线程的数据库更新操作还未完成（或数据还未到达DB服务器），则可能产生时序问题。

#### 如何解决时序问题？
我的初步设想：保证玩家**真正离开场景（当前线程）之前，数据库更新已完成(或数据到达了DB服务器)。**这样便保证了只有最新场景(线程)会操作该玩家的数据。  
那么玩家切换场景流程如下：
> 1. 从场景中删除玩家，玩家离开场景，将玩家挂起，此时禁止访问玩家数据，也不响应客户端请求。
> 2. 将玩家数据序列化，发起DB更新请求，如果是异步方式，则需要添加回调。
> 3. 等待数据库操作完成。
> 4. 删除玩家对象，开始进入新场景。

优点：逻辑足够简单，容易保证安全性。
缺陷：如果一个玩家要保存的数据较多，那么玩家切换场景的时间可能较长。